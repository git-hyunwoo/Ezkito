{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="d-flex align-items-end justify-content-between flex-wrap gap-3 mb-3">
    <div>
      <h1 class="mb-1">Add Background Color</h1>
      <p class="text-muted mb-0">Choose a preset or pick any color precisely with an advanced picker.</p>
    </div>
  </div>

  {% if error_message %}
    <div class="alert alert-danger">{{ error_message }}</div>
  {% endif %}

  <div class="row g-4">
    <!-- Left: controls -->
    <div class="col-lg-5">
      <div class="card p-4">
        <form id="bgColorForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Files</label>
            <input id="bgFiles" type="file" name="files" class="form-control" accept="image/*" multiple required>
            <div class="form-text">Single file shows live preview. Multiple files export as ZIP.</div>
          </div>

          <div class="mb-3">
            <div class="d-flex align-items-center justify-content-between">
              <label class="form-label mb-0">Background Color</label>
              <div class="d-flex align-items-center gap-2">
                <span class="badge text-bg-light border" id="hexBadge">#06595f</span>
                <span class="color-dot" id="colorDot" title="Selected color"></span>
              </div>
            </div>

            <!-- Presets -->
            <div class="preset-grid mt-2" id="presetGrid"></div>

            <!-- Advanced picker -->
            <div class="mt-3">
              <label class="form-label">Free pick</label>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <button type="button" id="pickrBtn" class="pickr-btn">
                  <span class="pickr-swatch" id="pickrSwatch"></span>
                  <span class="pickr-label">Open color picker</span>
                </button>

                <input id="hexInput" type="text" class="form-control" value="#06595f" maxlength="7"
                       style="max-width: 180px;" placeholder="#RRGGBB">
              </div>
              <div class="form-text">
                Use presets for speed, or open the picker for any color (hue/sat/value). You can also type HEX.
              </div>
            </div>

            <input type="hidden" name="color" id="colorHidden" value="#06595f">
          </div>

          <div class="mb-3">
            <label class="form-label">Output Format</label>
            <select id="outFormat" class="form-select" name="out_format">
              <option value="png" selected>PNG</option>
              <option value="jpg">JPG</option>
            </select>
            <div class="form-text">
              JPG removes transparency (good for solid backgrounds). PNG keeps alpha.
            </div>
          </div>

          <div class="d-flex justify-content-end">
            <button id="applyBtn" type="submit" class="btn btn-primary">Apply & Download</button>
          </div>
        </form>
      </div>

      <div class="alert alert-info mt-3 mb-0">
        Tip: If your input has transparency (PNG), the background change is very noticeable.
      </div>
    </div>

    <!-- Right: preview -->
    <div class="col-lg-7">
      <div class="card p-4">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Preview</h5>
          <small id="status" class="text-muted">Waiting for file…</small>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="preview-box">
              <div class="preview-title">Original</div>
              <div class="preview-area checker">
                <img id="origImg" alt="original preview">
                <div class="empty-state" id="origEmpty">No image selected</div>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="preview-box">
              <div class="preview-title">With Background</div>
              <div class="preview-area checker" id="resultWrap">
                <img id="resultImg" alt="result preview">
                <div class="empty-state" id="resultEmpty">Select a file to preview</div>

                <div class="loading-overlay" id="loading">
                  <div class="shimmer"></div>
                  <div class="loading-text">Rendering preview…</div>
                </div>
              </div>

              <div class="form-text mt-2">
                Preview is client-side (fast). Final output is generated by the server when you download.
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Pickr (CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css">
<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>

<style>
  .color-dot{
    width: 18px; height: 18px; border-radius: 50%;
    border: 1px solid rgba(0,0,0,.15);
    background: #06595f;
    display: inline-block;
  }

  .preset-grid{
    display: grid;
    grid-template-columns: repeat(10, 1fr);
    gap: 8px;
  }
  @media (max-width: 576px){
    .preset-grid{ grid-template-columns: repeat(8, 1fr); }
  }
  .swatch{
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 10px;
    border: 2px solid rgba(0,0,0,.08);
    cursor: pointer;
    position: relative;
    transition: transform .08s ease;
  }
  .swatch:hover{ transform: translateY(-1px); }
  .swatch.selected{
    border-color: rgba(13,110,253,.9);
    box-shadow: 0 0 0 3px rgba(13,110,253,.18);
  }

  .pickr-btn{
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.15);
    background: #fff;
    cursor: pointer;
    user-select: none;
  }
  .pickr-btn:hover{
    background: rgba(0,0,0,.02);
  }
  .pickr-swatch{
    width: 28px;
    height: 28px;
    border-radius: 10px;
    border: 1px solid rgba(0,0,0,.15);
    background: #06595f;
  }
  .pickr-label{
    font-weight: 700;
  }

  .preview-title{ font-weight: 600; margin-bottom: .5rem; }
  .preview-area{
    position: relative;
    width: 100%;
    aspect-ratio: 4 / 3;
    border: 1px solid rgba(0,0,0,.1);
    border-radius: 12px;
    overflow: hidden;
    background: #fafafa;
  }
  .checker{
    background:
      linear-gradient(45deg, #f2f2f2 25%, transparent 25%),
      linear-gradient(-45deg, #f2f2f2 25%, transparent 25%),
      linear-gradient(45deg, transparent 75%, #f2f2f2 75%),
      linear-gradient(-45deg, transparent 75%, #f2f2f2 75%);
    background-size: 24px 24px;
    background-position: 0 0, 0 12px, 12px -12px, -12px 0px;
  }
  .preview-area img{
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: none;
  }
  .empty-state{
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    color: rgba(0,0,0,.45);
    font-weight: 600;
    pointer-events: none;
  }

  .loading-overlay{
    position: absolute;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 12px;
    background: rgba(255,255,255,.6);
    backdrop-filter: blur(3px);
  }
  .loading-text{ font-weight: 700; }
  .shimmer{
    width: 80%;
    height: 14px;
    border-radius: 999px;
    background: linear-gradient(90deg, rgba(0,0,0,.08), rgba(0,0,0,.02), rgba(0,0,0,.08));
    background-size: 200% 100%;
    animation: shimmer 1.2s infinite linear;
  }
  @keyframes shimmer{
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
</style>

<script>
  const PRESETS = [
    "#ffffff", "#000000", "#f8f9fa", "#e9ecef", "#dee2e6",
    "#ff0000", "#ff6b6b", "#ffa94d", "#ffd43b", "#69db7c",
    "#38d9a9", "#3bc9db", "#4dabf7", "#5c7cfa", "#845ef7",
    "#be4bdb", "#f06595", "#06595f", "#adb5bd", "#495057",
  ];

  const presetGrid = document.getElementById("presetGrid");
  const hexInput = document.getElementById("hexInput");
  const hexBadge = document.getElementById("hexBadge");
  const colorDot = document.getElementById("colorDot");
  const colorHidden = document.getElementById("colorHidden");
  const pickrSwatch = document.getElementById("pickrSwatch");
  const pickrBtn = document.getElementById("pickrBtn");

  const filesInput = document.getElementById("bgFiles");
  const statusEl = document.getElementById("status");

  const origImg = document.getElementById("origImg");
  const origEmpty = document.getElementById("origEmpty");
  const resultImg = document.getElementById("resultImg");
  const resultEmpty = document.getElementById("resultEmpty");
  const loading = document.getElementById("loading");
  const resultWrap = document.getElementById("resultWrap");

  let origUrl = null;

  function normalizeHex(v){
    if (!v) return null;
    v = v.trim();
    if (!v.startsWith("#")) v = "#" + v;
    if (!/^#[0-9a-fA-F]{6}$/.test(v)) return null;
    return v.toLowerCase();
  }

  function setSelectedColor(hex){
    const n = normalizeHex(hex);
    if (!n) return;

    hexInput.value = n;
    hexBadge.textContent = n;
    colorDot.style.background = n;
    pickrSwatch.style.background = n;
    colorHidden.value = n;

    document.querySelectorAll(".swatch").forEach(el => {
      el.classList.toggle("selected", el.dataset.hex === n);
    });

    // set background color in preview wrap
    resultWrap.style.backgroundColor = n;

    if (filesInput.files && filesInput.files.length === 1) {
      renderClientPreview(filesInput.files[0], n);
    }
  }

  function buildSwatches(){
    presetGrid.innerHTML = "";
    PRESETS.forEach(hex => {
      const d = document.createElement("div");
      d.className = "swatch";
      d.style.background = hex;
      d.dataset.hex = hex.toLowerCase();
      d.title = hex;
      d.addEventListener("click", () => setSelectedColor(hex));
      presetGrid.appendChild(d);
    });
  }

  async function renderClientPreview(file, bgHex){
    loading.style.display = "flex";
    statusEl.textContent = "Rendering preview…";

    const img = new Image();
    img.decoding = "async";
    const url = URL.createObjectURL(file);
    img.src = url;

    await new Promise((resolve, reject) => {
      img.onload = () => resolve();
      img.onerror = () => reject(new Error("Failed to load image"));
    });

    const maxW = 1200;
    const scale = Math.min(1, maxW / img.width);
    const w = Math.max(1, Math.round(img.width * scale));
    const h = Math.max(1, Math.round(img.height * scale));

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;

    const ctx = canvas.getContext("2d");
    ctx.fillStyle = bgHex;
    ctx.fillRect(0, 0, w, h);
    ctx.drawImage(img, 0, 0, w, h);

    const dataUrl = canvas.toDataURL("image/png");

    URL.revokeObjectURL(url);

    resultImg.src = dataUrl;
    resultImg.style.display = "block";
    resultEmpty.style.display = "none";

    loading.style.display = "none";
    statusEl.textContent = "Ready";
  }

  filesInput.addEventListener("change", () => {
    if (origUrl) URL.revokeObjectURL(origUrl);
    origUrl = null;

    origImg.style.display = "none";
    resultImg.style.display = "none";
    origEmpty.style.display = "grid";
    resultEmpty.style.display = "grid";

    if (!filesInput.files || filesInput.files.length === 0) {
      statusEl.textContent = "Waiting for file…";
      return;
    }

    origUrl = URL.createObjectURL(filesInput.files[0]);
    origImg.src = origUrl;
    origImg.style.display = "block";
    origEmpty.style.display = "none";

    if (filesInput.files.length === 1) {
      statusEl.textContent = "Preview enabled";
      setSelectedColor(colorHidden.value);
    } else {
      statusEl.textContent = `${filesInput.files.length} files selected (ZIP export). Preview shows the first file only.`;
      resultWrap.style.backgroundColor = colorHidden.value;
      resultEmpty.style.display = "grid";
    }
  });

  hexInput.addEventListener("input", (e) => {
    const n = normalizeHex(e.target.value);
    if (n) {
      setSelectedColor(n);
      pickr.setColor(n, true);
    }
  });

  // Build palette
  buildSwatches();

  // Pickr init (advanced picker)
  const pickr = Pickr.create({
    el: '#pickrBtn',
    theme: 'classic',
    default: '#06595f',
    useAsButton: true,
    lockOpacity: true,
    swatches: PRESETS,
    components: {
      preview: true,
      opacity: false,
      hue: true,
      interaction: {
        hex: true,
        rgba: true,
        input: true,
        save: true,
        clear: false
      }
    }
  });

  pickr.on('change', (color) => {
    const hex = color.toHEXA().toString().toLowerCase();
    setSelectedColor(hex);
  });

  pickr.on('save', (color) => {
    const hex = color.toHEXA().toString().toLowerCase();
    setSelectedColor(hex);
    pickr.hide();
  });

  // init default
  setSelectedColor("#06595f");
</script>
{% endblock %}
